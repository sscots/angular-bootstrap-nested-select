<ng-template #optionTemplate let-options="options" let-i="index">
    <ng-template ngFor [ngForOf]="options" let-opt>
        <div class="index-{{i}} option"
             [ngClass]="{
               'dropdown-item': (!opt[settings.field] || !opt[settings.field].length || settings.selectAll || settings.collapsed),
               'text-primary': opt == _selected
             }"
             (click)="selectOption($event, opt)">
						<span *ngIf="opt[settings.field] && opt[settings.field].length && settings.collapsed"
                              class="fa mr-2 toggle-icon"
                              [ngClass]="{
                    'fa-angle-right': !opt.selected,
                    'fa-angle-down': opt.selected,
                    'border border-secondary px-1 rounded': this.settings.selectAll
                  }"
                              (click)="selectOption($event, opt, true)">
            </span>
            <span [innerHTML]="opt[settings.label]" class="option-label"></span>
        </div>
        <div class="option-container" *ngIf="opt[settings.field] && opt[settings.field].length && (!settings.collapsed || opt.selected)">
            <ng-container
                    [ngTemplateOutlet]="optionTemplate"
                    [ngTemplateOutletContext]="{options: opt[settings.field], index: (i+1)}">
            </ng-container>
        </div>
    </ng-template>
</ng-template>
<div *ngIf="_disabled"
     class="filter-read"
     [innerHTML]="_selected[settings.label]"
     placement="top"
     popoverTitle="Product Details:"
     #p="ngbPopover"
     [ngbPopover]="productName"
     triggers="mouseenter:mouseleave">
</div>
<div *ngIf="!_disabled"
     ngbDropdown
     class="nested-select"
     #nestedDrop="ngbDropdown"
     (openChange)="ngOnInit()">
    <input *ngIf="settings.filter && filterOn"
           ngbDropdownToggle
           type="text"
           name="filterInput"
           id="filterInput"
           [(ngModel)]="_searchTerm"
           (ngModelChange)="filterOptions()"
           #filterInput (click)="filterOptions()"
           (focusout)="hideFilter()"
           autocomplete="off" />

    <input *ngIf="!settings.filter && !settings.strict"
           ngbDropdownToggle
           [type]="(settings.numberInput ? 'number' : 'text')"
           name="typedInput"
           id="typedInput"
           [(ngModel)]="_selected[settings.label]"
           #typedInput
           (ngModelChange)="selectOption($event)"
           autocomplete="off" />

    <div *ngIf="settings.filter && !filterOn"
         ngbDropdownToggle
         class="filter-read"
         [innerHTML]="_selected[settings.label]"
         (click)="showFilter();">
    </div>

    <div *ngIf="!settings.filter && settings.strict"
         ngbDropdownToggle
         class="filter-read"
         [innerHTML]="_selected[settings.label]">
    </div>

    <div ngbDropdownMenu
         aria-labelledby="dropdownMenuButton"
         [ngClass]="{
            'scroll': settings.scroll,
            'top': settings.top
          }">

        <div *ngIf="hasOptions() && settings.clear && settings.actions == 'text'"
             class="option text-secondary dropdown-item clear"
             (click)="selectOption($event)">
            Clear
        </div>
        <ng-template [ngIf]="(actions.length > 0) && settings.actions == 'text'">
            <div class="option text-secondary dropdown-item"
                 *ngFor="let action of actions"
                 (click)="selectAction(action)"
                 [innerHTML]="action.label">
            </div>
        </ng-template>

        <div class="option dropdown-item" *ngIf="settings.actions == 'buttons'">
            <ng-template [ngIf]="(actions.length > 0)">
                <div class="btn btn-xs btn-light float-right ml-1"
                     *ngFor="let action of actions"
                     (click)="selectAction(action)"
                     [innerHTML]="action.label">
                </div>
            </ng-template>
            <div class="btn btn-xs btn-light float-right ml-1"
                 *ngIf="hasOptions()"
                 (click)="selectOption($event)">
                Clear
            </div>
        </div>

        <div class="option" *ngIf="!hasOptions()">No Options Available</div>
        <ng-container
                [ngTemplateOutlet]="optionTemplate"
                [ngTemplateOutletContext]="{options: _optionsFiltered, index: 1}">
        </ng-container>
    </div>
</div>

<ng-template #productName>
    <div [innerHTML]="_selected[settings.label]"></div>
</ng-template>
